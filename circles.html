<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circles</title>
</head>

<body>
    <div id="ui-layer">
        <h1>Put in your favorite image</h1>
        <label class="custom-upload-btn">
            <input type="file" id="upload" accept="image/*">
            Select Image
        </label>
    </div>

    <canvas id="displayCanvas"></canvas>

    <script>
        const displayCanvas = document.getElementById('displayCanvas');
        const ctx = displayCanvas.getContext('2d');
        const hiddenCanvas = document.createElement('canvas');
        const hiddenCtx = hiddenCanvas.getContext('2d');
        const uiLayer = document.getElementById('ui-layer');

        let circles = [];

        class Circle {
            constructor(x, y, size, color) {
                this.x = x;
                this.y = y;
                this.size = size;
                this.radius = size / 2;
                this.color = color;
                this.isSplit = false;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x + this.radius, this.y + this.radius, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.closePath();
            }

            checkMouse(mx, my) {
                if (this.isSplit) return;
                const dx = mx - (this.x + this.radius);
                const dy = my - (this.y + this.radius);
                const distance = Math.sqrt(dx * dx + dy * dy);

                // Minimum size logic: Stop splitting at 1px
                if (distance < this.radius && this.size > 1) {
                    this.split();
                }
            }

            split() {
                this.isSplit = true;
                const half = this.size / 2;

                addCircle(this.x, this.y, half);
                addCircle(this.x + half, this.y, half);
                addCircle(this.x, this.y + half, half);
                addCircle(this.x + half, this.y + half, half);

                const index = circles.indexOf(this);
                if (index > -1) circles.splice(index, 1);
            }
        }

        function getAverageColor(x, y, w, h) {
            const imageData = hiddenCtx.getImageData(x, y, w, h);
            const data = imageData.data;
            let r = 0, g = 0, b = 0;

            for (let i = 0; i < data.length; i += 4) {
                r += data[i];
                g += data[i + 1];
                b += data[i + 2];
            }

            const count = data.length / 4;
            r = Math.floor(r / count);
            g = Math.floor(g / count);
            b = Math.floor(b / count);

            return `rgb(${r},${g},${b})`;
        }

        function addCircle(x, y, size) {
            const color = getAverageColor(x, y, size, size);
            circles.push(new Circle(x, y, size, color));
        }

        function animate() {
            ctx.clearRect(0, 0, displayCanvas.width, displayCanvas.height);
            for (let i = 0; i < circles.length; i++) {
                circles[i].draw();
            }
            requestAnimationFrame(animate);
        }

        displayCanvas.addEventListener('mousemove', (e) => {
            const rect = displayCanvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;

            for (let i = circles.length - 1; i >= 0; i--) {
                circles[i].checkMouse(mx, my);
            }
        });

        document.getElementById('upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (event) {
                const img = new Image();
                img.onload = function () {
                    init(img);
                    uiLayer.style.display = 'none';
                    displayCanvas.style.display = 'block';
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        function init(img) {
  
            const screenMin = Math.min(window.innerWidth, window.innerHeight) - 40;

            const size = Math.min(screenMin, 1024);

            displayCanvas.width = size;
            displayCanvas.height = size;
            hiddenCanvas.width = size;
            hiddenCanvas.height = size;

            hiddenCtx.drawImage(img, 0, 0, size, size);

            circles = [];
            addCircle(0, 0, size);

            animate();
        }
    </script>
        <style>
            body {
                margin: 0;
                overflow: hidden;
                background: #1a1a1a;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                color: white;
            }
        
            canvas {
                box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
                cursor: crosshair;
                display: none;
            }
        
            #ui-layer {
                text-align: center;
                position: absolute;
                z-index: 10;
                transition: opacity 0.5s ease;
            }
        
            h1 {
                font-weight: 300;
                letter-spacing: 2px;
                margin-bottom: 30px;
                font-size: 2rem;
                text-transform: uppercase;                
            }
        
            input[type="file"] {
                display: none;
            }
        
            .custom-upload-btn {
                background: linear-gradient(135deg, #0da32b, #fa9c05);
                color: white;
                padding: 15px 40px;
                font-size: 18px;
                border-radius: 50px;
                cursor: pointer;
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
                transition: transform 0.2s, box-shadow 0.2s;
                display: inline-block;
                font-weight: 600;
            }
        
            .custom-upload-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            }
        
            .custom-upload-btn:active {
                transform: translateY(1px);
            }
        </style>
</body>
</html>